const corsHeaders = {
  "Access-Control-Allow-Origin": "*",
  "Access-Control-Allow-Methods": "GET,POST,OPTIONS",
  "Access-Control-Allow-Headers": "Content-Type"
};

async function ensurePlayersTable(db) {
  await db.prepare(
    `CREATE TABLE IF NOT EXISTS players (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      character TEXT NOT NULL,
      sheet TEXT NOT NULL,
      avatar TEXT NOT NULL,
      notes TEXT,
      created_at TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
    )`
  ).run();
}

function jsonResponse(data, init = {}) {
  const headers = {
    "Content-Type": "application/json",
    ...corsHeaders,
    ...(init.headers || {})
  };

  return new Response(JSON.stringify(data), { ...init, headers });
}

export default {
  async fetch(request, env) {
    const url = new URL(request.url);

    if (request.method === "OPTIONS") {
      return new Response(null, { headers: corsHeaders });
    }

    try {
      if (url.pathname === "/players" && request.method === "GET") {
        await ensurePlayersTable(env.DB);

        const { results } = await env.DB.prepare(
          "SELECT * FROM players ORDER BY created_at ASC"
        ).all();
        return jsonResponse(results);
      }

      if (url.pathname === "/players" && request.method === "POST") {
        const body = await request.json();
        await ensurePlayersTable(env.DB);
        await env.DB.prepare(
          "INSERT INTO players (name, character, sheet, avatar, notes) VALUES (?, ?, ?, ?, ?)"
        )
          .bind(body.name, body.character, body.sheet, body.avatar, body.notes)
          .run();
        return jsonResponse({ status: "success" }, { status: 201 });
      }

      if (url.pathname === "/chat" && request.method === "GET") {
        const { results } = await env.DB.prepare(
          "SELECT * FROM chat ORDER BY created_at DESC LIMIT 20"
        ).all();
        return jsonResponse(results);
      }

      if (url.pathname === "/chat" && request.method === "POST") {
        const body = await request.json();
        await env.DB.prepare("INSERT INTO chat (user, message) VALUES (?, ?)")
          .bind(body.user, body.message)
          .run();
        return jsonResponse({ status: "success" }, { status: 201 });
      }

      return new Response("Not Found", { status: 404, headers: corsHeaders });
    } catch (error) {
      console.error("Worker error", error);
      return jsonResponse({ error: "Internal Server Error" }, { status: 500 });
    }
  }
};
